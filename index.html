<!DOCTYPE html>
<html>
<head>
  <title>Crypto Average Chart</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; }
    #chart { width: 100%; height: 90vh; }
    #status { padding: 10px; text-align: center; }
  </style>
</head>
<body>
  <div id="status">⏳ Loading chart data...</div>
  <div id="chart"></div>

  <script>
    async function fetchCryptoData(id) {
      try {
        const response = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/ohlc?vs_currency=usd&days=1`);
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        return await response.json();
      } catch (err) {
        console.error(`Error fetching ${id}:`, err);
        throw err;
      }
    }

    async function loadChart() {
      const statusDiv = document.getElementById("status");
      try {
        const [btc, eth, ltc, bch] = await Promise.all([
          fetchCryptoData("bitcoin"),
          fetchCryptoData("ethereum"),
          fetchCryptoData("litecoin"),
          fetchCryptoData("bitcoin-cash")
        ]);

        if (!btc.length || !eth.length || !ltc.length || !bch.length) {
          statusDiv.textContent = "❌ Data not available. Try again later.";
          return;
        }

        const candles = [];
        for (let i = 0; i < btc.length; i++) {
          const time = Math.floor(btc[i][0] / 1000);
          const open  = (btc[i][1] + eth[i][1] + ltc[i][1] + bch[i][1]) / 4;
          const high  = (btc[i][2] + eth[i][2] + ltc[i][2] + bch[i][2]) / 4;
          const low   = (btc[i][3] + eth[i][3] + ltc[i][3] + bch[i][3]) / 4;
          const close = (btc[i][4] + eth[i][4] + ltc[i][4] + bch[i][4]) / 4;
          candles.push({ time, open, high, low, close });
        }

        statusDiv.style.display = "none";

        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
          layout: { backgroundColor: '#111', textColor: '#fff' },
          grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
          width: window.innerWidth,
          height: window.innerHeight * 0.9
        });

        const series = chart.addCandlestickSeries();
        series.setData(candles);
      } catch (e) {
        document.getElementById("status").textContent = "⚠️ Failed to load data. Try again shortly.";
      }
    }

    loadChart();
  </script>
</body>
</html>
